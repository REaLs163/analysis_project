# Разметка PDF-файлов анализов с отклонениями при помощи Yandex Cloud Functions и Object Storage
При помощи объектного хранилища, триггера и функции можно легко определять отклонения в анализах людей.

# ⚙️ Гайд по развёртке и настройке инфраструктуры

1. Перед началом нужно [зарегистрировать аккаунт в Yandex Cloud](https://yandex.cloud/ru/docs/billing/quickstart/#individuals_1).

2. Затем создайте [первое облако](https://yandex.cloud/ru/docs/resource-manager/operations/cloud/create) и [каталог](https://yandex.cloud/ru/docs/resource-manager/operations/folder/create).

3. Далее нужно создать [сервисный аккаунт](https://yandex.cloud/ru/docs/iam/quickstart-sa) с ролью `admin` на католог, от имени которого будут выполнятся операции.

4. Создайте [бакет](https://yandex.cloud/ru/docs/storage/operations/buckets/create) в сервисе Object Storage. Для этого:

1) Перейдите в сервис "Object Storage".
2) Справа сверху нажмите кнопку "Создать бакет".
3) Задайте имя бакета. Оно должно соответствовать правилам именования.
4) Класс хранилища: `Стандартное`.
5) Максимальный размер бакета ограничить до 1 ГБ.
6) Добавить метку в формате `ключ: значение`.
7) Все остальные параметры оставить по умолчанию.
8) Нажмите на кнопку "Создать".

5. После создания бакета, создайте в нём две папки: input и output. В первую буду загружаться все PDF-файлы, а во вторую будут помещаться автоматически файлы анализов с отклонениями.

6. [Получите](https://yandex.cloud/ru/docs/iam/concepts/authorization/access-key) статические ключи доступа для аутентификации сервисного аккаунта в S3. Они понадобятся в будущем, при настройке экземпляра Cloud Functions. По поводу ключей отмечу, что их нужно будет сохранить отдельно сразу, т.к. потом мы их не увидим.

7. Создайте экземпляр [функции и её первую версию на Python 3.12](https://yandex.cloud/ru/docs/functions/quickstart/create-function/python-function-quickstart) в сервисе Cloud Functions. Для этого:

1) Перейдите в сервис "Cloud Functions".
2) Справа сверху нажмите кнопку "Создать функцию".
3) Задайте имя функции.
4) Клонируйте репозиторий на локальную машину:

```bash
git clone <repository_url>
```

5) При создании функции выбирете среду разработки Python 3.12.
6) В редакторе функции создайте три файла:

```text
.env
requirements.txt
cloud_function.py
```
7) Файл .env заполните следующими данными:

```python
AWS_ACCESS_KEY_ID=KEY_ID
AWS_SECRET_ACCESS_KEY=ACCESS_KEY
AWS_REGION=ru-central1
S3_ENDPOINT=https://storage.yandexcloud.net   
S3_BUCKET=BUCKET_NAME
INPUT_PREFIX=input/
OUTPUT_PREFIX=output/
```

8. Перейдем к настройке функции:

1) Точка входа: `cloud_function.handler`.
2) Таймаут: 5 сек.
3) Память: 384 МБ.
4) В поле "Сервисный аккаунт" выбирете раннее созданный аккаунт.
5) Все остальные параметры оставить по умолчанию.
6) Нажмите на кнопку "Создать".
7) Перейдите в "Обзор" и добавьте метку.

9. Теперь нам нужно создать [триггер](https://yandex.cloud/ru/docs/functions/operations/trigger/os-trigger-create), который автоматически будет вызывать экземпляр функции при загрузке PDF-файлов в папку `input` в бакет. Для этого:

1) На левой панели выбирете "Триггер".
2) Справа сверху нажмите кнопку "Создать триггер".
3) Задайте имя триггера.
4) Тип: `Object Storage`.
5) В поле "Бакет" укажите ранее созданный бакет.
6) Типы событий: `Создание объекта`.
7) В поле "Префикс ключа объекта" введите: `input/`.
8) Время ожидания: 1.
9) В поле "Функция" укажите ранее созданную функцию.
10) Тег версии функции укажите: `$latest`.
11) В поле "Сервисный аккаунт" выбирете раннее созданный аккаунт.
12) Нажмите на кнопку "Создать".

10. Протестируйте работу инфраструктуры. Для этого загрузите несколько файлов в бакет в папку `input/`. Через время в нашем фолдере появится новый сервис Cloud Logging. Перейдите в него и выполните следующие действия:

1) Выбирете появившуюся группу.
2) Перейдите в "Обзор" и справа сверху нажмите кнопку "Редактировать".
3) Измените праметр "Срок хранения логов" на 1 час.
4) Сохраните изменения.

# Требования к функции

- Python 3.12+